# üè¢ API Devolu√ß√£o Betha - Cornelio Proc√≥pio

Sistema modular para gera√ß√£o de JSONs de im√≥veis compat√≠veis com a API da Betha Cloud, extraindo dados do banco GEON.

## ‚ú® Funcionalidades

### Op√ß√£o 4 - Gerar JSON de IM√ìVEL para devolu√ß√£o (Betha)

Extrai dados completos do banco GEON e gera JSON compat√≠vel com a API Betha contendo:

#### üìä Dados Extra√≠dos:

**Informa√ß√µes B√°sicas:**

- ID do Im√≥vel
- Inscri√ß√£o Imobili√°ria
- Tipo (URBANO/RURAL)
- Situa√ß√£o
- Coordenadas geogr√°ficas (latitude/longitude)
- Setor, quadra, lote, matr√≠cula

**√Åreas:**

- √Årea do lote
- √Årea de cada edifica√ß√£o (por sequ√™ncia)
- √Årea total constru√≠da

**BICs do Lote (6 campos):**

- Meio Fio
- Pavimenta√ß√£o
- Ocupa√ß√£o
- Utiliza√ß√£o
- Situa√ß√£o
- Cerca/Muro

**BICs da Edifica√ß√£o (13 campos):**

- Tipo
- Alinhamento
- Localiza√ß√£o
- Posi√ß√£o
- Estrutura
- Cobertura
- Veda√ß√£o
- Forro
- Revestimento Externo
- Sanit√°rios
- Acabamento Interno
- Piso
- Conserva√ß√£o

#### üéØ Exemplo de Uso:

```bash
python3 src/main.py
# Escolha op√ß√£o 4
# Informe o cadastro (ex: 45)
```

**Sa√≠da:**

```
‚úÖ JSON gerado com sucesso!
üìÅ Arquivo: data/json/post_imoveis/45.json

üìä Estat√≠sticas:
   ‚Ä¢ Cadastro: 45
   ‚Ä¢ Inscri√ß√£o: 0101001
   ‚Ä¢ Tipo: URBANO
   ‚Ä¢ Total de campos adicionais: 22
   ‚Ä¢ √Åreas: 3
   ‚Ä¢ BICs do Lote: 6
   ‚Ä¢ BICs da Edifica√ß√£o: 13
```

## üìã Estrutura do Projeto

"""

import sys```

from pathlib import Pathcornelio/

‚îú‚îÄ‚îÄ src/

# Adicionar src ao path‚îÇ ‚îú‚îÄ‚îÄ main.py # Menu principal

sys.path.insert(0, str(Path(**file**).parent / "src"))‚îÇ ‚îú‚îÄ‚îÄ assets/

‚îÇ ‚îÇ ‚îú‚îÄ‚îÄ sql.py # Queries SQL originais

from utils.transformers.imovel_builder import (‚îÇ ‚îÇ ‚îî‚îÄ‚îÄ token_betha.json # Configura√ß√£o da API

    build_imovel_payload,‚îÇ   ‚îú‚îÄ‚îÄ utils/

    write_imovel_payload,‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ database/

)‚îÇ ‚îÇ ‚îÇ ‚îî‚îÄ‚îÄ conn.py # Conex√£o com banco

from colorama import Fore, Style‚îÇ ‚îÇ ‚îú‚îÄ‚îÄ transformers/

‚îÇ ‚îÇ ‚îÇ ‚îú‚îÄ‚îÄ imovel_builder.py # Construtor principal do JSON

‚îÇ ‚îÇ ‚îÇ ‚îú‚îÄ‚îÄ sql_queries_simple.py # Queries SQL organizadas

def gerar_jsons_em_lote(cadastros: list[int]) -> None:‚îÇ ‚îÇ ‚îÇ ‚îú‚îÄ‚îÄ data_mappers.py # Mapeadores de dados

    """‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ bic_extractor.py       # Extrator de BICs

    Gera JSONs para uma lista de cadastros.‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ areas_extractor.py     # Extrator de √°reas

‚îÇ ‚îÇ ‚îî‚îÄ‚îÄ api/

    Args:‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ imovel/                 # APIs de im√≥veis

        cadastros: Lista de n√∫meros de cadastro‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ pessoa/                 # APIs de pessoas

    """‚îÇ   ‚îî‚îÄ‚îÄ cli/

    total = len(cadastros)‚îÇ       ‚îî‚îÄ‚îÄ console.py                  # Interface do usu√°rio

    sucessos = 0‚îî‚îÄ‚îÄ data/

    erros = 0    ‚îî‚îÄ‚îÄ json/

        ‚îú‚îÄ‚îÄ get_imovel/                 # Downloads da API

    print(f"\n{Fore.CYAN}Gerando JSONs para {total} cadastros...{Style.RESET_ALL}\n")        ‚îú‚îÄ‚îÄ get_imovelcamposadicionais/ # Campos adicionais

    print("=" * 70)        ‚îî‚îÄ‚îÄ post_imoveis/               # JSONs para devolu√ß√£o ‚ú®



    for i, cadastro in enumerate(cadastros, 1):```

        try:

            # Gerar payload## üéØ Funcionalidades Implementadas

            payload = build_imovel_payload(cadastro)

### ‚úÖ Dados Extra√≠dos do Banco GEON

            # Salvar arquivo

            arquivo = write_imovel_payload(cadastro, payload)1. **Dados B√°sicos**

- ID do im√≥vel

         # Estat√≠sticas   - Inscri√ß√£o imobili√°ria

         campos_adicionais = len(payload.get("camposAdicionais", []))   - Matr√≠cula

- Tipo (Urbano/Rural)

         print(   - Situa√ß√£o (Ativado/Inativo)

             f"{Fore.GREEN}‚úì{Style.RESET_ALL} [{i}/{total}] "   - Setor, Quadra, Lote

             f"Cadastro {cadastro}: "

             f"{campos_adicionais} campos adicionais"2. **Localiza√ß√£o**

         )   - Latitude e Longitude (coordenadas geogr√°ficas)

- Endere√ßo completo (quando dispon√≠vel)

         sucessos += 1

3.  **√Åreas** üÜï

         except Exception as e:   - ‚úÖ √Årea do Lote

             print(   - ‚úÖ √Årea de cada Edifica√ß√£o (por sequ√™ncia)

                 f"{Fore.RED}‚úó{Style.RESET_ALL} [{i}/{total}] "   - ‚úÖ √Årea Total Constru√≠da

                 f"Cadastro {cadastro}: {str(e)[:50]}..."

             )4. **BICs (Boletim de Informa√ß√µes Cadastrais)** üÜï

             erros += 1

    **BICs do Lote:**

    print("=" \* 70) - Meio Fio

    print(f"\n{Fore.CYAN}Resumo:{Style.RESET_ALL}") - Pavimenta√ß√£o

    print(f" {Fore.GREEN}‚úì Sucessos: {sucessos}{Style.RESET_ALL}") - Ocupa√ß√£o

    if erros > 0: - Utiliza√ß√£o

         print(f"  {Fore.RED}‚úó Erros: {erros}{Style.RESET_ALL}")   - Situa√ß√£o

    print(f"\n{Fore.YELLOW}Arquivos salvos em: data/json/post_imoveis/{Style.RESET_ALL}\n") - Cerca/Muro

    **BICs da Edifica√ß√£o:**

if **name** == "**main**": - Tipo

    # Lista de cadastros para processar   - Alinhamento

    # Voc√™ pode modificar esta lista conforme necess√°rio   - Localiza√ß√£o

    CADASTROS = [   - Posi√ß√£o

        1, 47, 1000, 1001, 1002,   - Estrutura

        1498, 29264   - Cobertura

    ]   - Veda√ß√£o

- Forro

  # Ou ler de um arquivo: - Revestimento Externo

  # with open("cadastros.txt") as f: - Sanit√°rios

  # CADASTROS = [int(line.strip()) for line in f if line.strip()] - Acabamento Interno

- Piso

  # Gerar JSONs - Conserva√ß√£o

  gerar_jsons_em_lote(CADASTROS) - Utiliza√ß√£o

## üöÄ Como Usar

### Op√ß√£o 1: Via Menu Interativo

```bash
cd "cornelio"
python3 src/main.py
```

Escolha a op√ß√£o **[ 4 ] Gerar JSON de IM√ìVEL para devolu√ß√£o**

### Op√ß√£o 2: Via C√≥digo Python

```python
from src.utils.transformers.imovel_builder import build_imovel_payload, write_imovel_payload

# Gerar JSON para um cadastro espec√≠fico
cadastro = 1
payload = build_imovel_payload(cadastro)

# Salvar em arquivo
arquivo = write_imovel_payload(cadastro, payload)
print(f"JSON salvo em: {arquivo}")
```

### Op√ß√£o 3: Gerar M√∫ltiplos JSONs

```python
from src.utils.transformers.imovel_builder import build_imovel_payload, write_imovel_payload

cadastros = [1, 47, 1000, 1001, 1002]

for cadastro in cadastros:
    try:
        payload = build_imovel_payload(cadastro)
        arquivo = write_imovel_payload(cadastro, payload)
        print(f"‚úì Cadastro {cadastro}: {arquivo}")
    except Exception as e:
        print(f"‚úó Cadastro {cadastro}: Erro - {e}")
```

## üìÑ Exemplo de JSON Gerado

```json
{
  "idImovel": 1,
  "inscricaoImobiliaria": "0101001",
  "tipoImovel": "URBANO",
  "situacao": "ATIVADO",
  "unidade": 0,
  "matricula": "0231-A",
  "setor": "01",
  "quadra": "01",
  "lote": "001",
  "latitude": 7436507.451099921,
  "longitude": 535993.3114857201,
  "camposAdicionais": [
    {
      "campoAdicional": {
        "titulo": "√Årea do Lote",
        "tipo": "NUMERICO"
      },
      "vlCampo": 231.0
    },
    {
      "campoAdicional": {
        "titulo": "√Årea edifica√ß√£o seq 1",
        "tipo": "NUMERICO"
      },
      "vlCampo": 220.87
    },
    {
      "campoAdicional": {
        "titulo": "√Årea Total Constru√≠da",
        "tipo": "NUMERICO"
      },
      "vlCampo": 220.87
    }
  ],
  "enderecoCorrespondencia": "IMOVEL",
  "usarEnderecoCondominio": "NAO"
}
```

## üîß Arquitetura Clean Code

O projeto segue princ√≠pios de **Clean Code** e **SOLID**:

- **Modularidade**: Cada m√≥dulo tem uma responsabilidade √∫nica
- **Separa√ß√£o de Responsabilidades**: SQL, mapeamento e constru√ß√£o s√£o m√≥dulos independentes
- **F√°cil Manuten√ß√£o**: C√≥digo organizado e documentado
- **Extens√≠vel**: F√°cil adicionar novos campos e funcionalidades

### M√≥dulos Principais

1. **`imovel_builder.py`**: Orquestrador principal que monta o JSON
2. **`sql_queries_simple.py`**: Todas as queries SQL organizadas
3. **`data_mappers.py`**: Convers√£o de dados brutos para formato API
4. **`bic_extractor.py`**: Extra√ß√£o de BICs do banco
5. **`areas_extractor.py`**: Extra√ß√£o e c√°lculo de √°reas

## üìä Status da Implementa√ß√£o

| Funcionalidade  | Status | Observa√ß√µes                |
| --------------- | ------ | -------------------------- |
| Dados b√°sicos   | ‚úÖ     | Completo                   |
| Coordenadas     | ‚úÖ     | Latitude/Longitude         |
| √Åreas           | ‚úÖ     | Lote e Edifica√ß√µes         |
| BICs Lote       | ‚úÖ     | Estrutura pronta           |
| BICs Edifica√ß√£o | ‚úÖ     | Estrutura pronta           |
| Propriet√°rios   | ‚ö†Ô∏è     | Precisa ajuste nas queries |
| Testadas        | ‚ö†Ô∏è     | Precisa ajuste nas queries |
| Loteamento      | ‚ö†Ô∏è     | Precisa ajuste nas queries |
| Condom√≠nio      | ‚ö†Ô∏è     | Precisa ajuste nas queries |

## üîÑ Pr√≥ximos Passos

1. Ajustar queries de propriet√°rios/respons√°veis
2. Completar extra√ß√£o de testadas
3. Adicionar dados de loteamento/condom√≠nio
4. Implementar valida√ß√£o dos JSONs antes do POST
5. Criar logs de processamento

## üíª Requisitos

- Python 3.8+
- PostgreSQL com banco GEON
- Bibliotecas: `psycopg2`, `requests`, `colorama`

## üìû Suporte

Para d√∫vidas ou sugest√µes, consulte a documenta√ß√£o da API Betha:

- https://arrecadacao.ajuda.betha.cloud/tributos/conteudostecnicos/migracao
- https://arrecadacao.ajuda.betha.cloud/tributos/conteudostecnicos/interacao/geoprocessamento
